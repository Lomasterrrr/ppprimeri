#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#include <net/bpf.h>
#include <net/if.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/ioctl.h>
#include <sys/time.h>

#include <fcntl.h>
#include <time.h>

int main(void)
{
	int fd;
	u_char bytes[] = {0x4, 0xbf, 0x6d, 0xd, 0x3a, 0x50, 0x40, 0xb0, 0x76, 0x47, 0x8f, 0x9a, 0x8, 0x0, 0x45, 0x0, 0x0, 0x54, 0x2c, 0xf5, 0x0, 0x0, 0x40, 0x1, 0xa8, 0x9c, 0xc0, 0xa8, 0x1, 0x22, 0x40, 0xe9, 0xa2, 0x64, 0x8, 0x0, 0x40, 0xd4, 0x97, 0x2f, 0x0, 0x0, 0x0, 0x0, 0x26, 0xe, 0x1c, 0x4d, 0xf2, 0x9d, 0x8, 0x9, 0xa, 0xb, 0xc, 0xd, 0xe, 0xf, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37};

	u_char buf[65535];
	ssize_t r, off;
	u_int n;

	fd = open("/dev/bpf", O_RDWR);

	n = 2500;
	ioctl(fd, BIOCSBLEN, &n);
	ioctl(fd, BIOCSETIF, &(struct ifreq){ .ifr_name = "re0" });

	write(fd, bytes, sizeof(bytes));
	ioctl(fd, BIOCGBLEN, &n);
	printf("%u\n", n);
	
	r = read(fd, buf, n);
	for (off = 0; off < r;) {
		struct bpf_hdr *hdr = (struct bpf_hdr *)(buf + off);

		printf("caplen=%u datalen=%u hdrlen=%u\n",
			hdr->bh_caplen, hdr->bh_datalen, hdr->bh_hdrlen);
		
		off += BPF_WORDALIGN(hdr->bh_hdrlen + hdr->bh_caplen);
	}

	ioctl(fd, BIOCFLUSH, NULL);
	struct bpf_stat bs;
	ioctl(fd, BIOCGSTATS, &bs);
	
	printf("bs.bs_recv=%u bs.bs_drop=%u\n", bs.bs_recv, bs.bs_drop);

	close(fd);
}
